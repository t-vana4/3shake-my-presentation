name: Deploy Slides to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build all slides
        run: |
          BASE_PATH="/${{ github.event.repository.name }}"
          for dir in slides/*/; do
            slide_name=$(basename "$dir")
            echo "Building: $slide_name"
            npx slidev build "$dir/slides.md" \
              --base "${BASE_PATH}/${slide_name}/" \
              --out "../../dist/${slide_name}"
          done

      - name: Generate index page
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          LINKS=""
          for dir in slides/*/; do
            slide_name=$(basename "$dir")
            title=$(grep -m1 '^title:' "$dir/slides.md" | sed 's/^title: *//' || echo "$slide_name")
            LINKS="${LINKS}<li><a href=\"/${REPO_NAME}/${slide_name}/\">${title}</a></li>"
          done
          cat > dist/index.html <<EOF
          <!DOCTYPE html>
          <html lang="ja">
          <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Presentations</title>
          <style>
          body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 40px auto; padding: 0 20px; color: #333; }
          h1 { border-bottom: 2px solid #eee; padding-bottom: 10px; }
          ul { list-style: none; padding: 0; }
          li { margin: 12px 0; }
          a { text-decoration: none; color: #0366d6; font-size: 1.1em; }
          a:hover { text-decoration: underline; }
          </style>
          </head>
          <body>
          <h1>Presentations</h1>
          <ul>${LINKS}</ul>
          </body>
          </html>
          EOF

      - uses: actions/configure-pages@v4

      - uses: actions/upload-pages-artifact@v3
        with:
          path: dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
